#!/usr/bin/env bash

PRINT() {
	printf "%b\n" "$@" 
}

TRIM ()
{
    local var="$*"

    # remove leading whitespace characters
    var="${var##*( )}"
    
	# remove trailing whitespace characters
    var="${var%%*( )}"
    
    # Return trimmed string
    printf '%s' "$var"
}

# Check if running as root
if [[ $EUID -eq 0 ]]; then

	PROGRAM_NAME="$(basename "$0")"

	PRINT "'${PROGRAM_NAME}' should not be run as root. Please try again as a normal user."
	exit 1
fi

_fetchSessions() {
	SESSIONS=( "$(loginctl list-sessions | grep $(whoami) | awk 'BEGIN {ORS=" "}; {print $1}')" )
	return 0
}

_lock() { 
	_fetchSessions

	for SESSION in "${SESSIONS[@]}"; do
		loginctl lock-session "$SESSION"
	done

	return 0
}

_unlock() {
	_fetchSessions
	
	for SESSION in "${SESSIONS[@]}"; do
		loginctl unlock-session "$SESSION"
	done

	return 0
}

_logout() {
	_fetchSessions

	for SESSION in "${SESSIONS[@]}"; do
		loginctl kill-session "$SESSION"
	done

	return 0
}

_list()
{
	_fetchSessions
	IDS="$(TRIM ${SESSIONS[@]})"
	PRINT "[ ${IDS// /, } ]"
	return 0
}

_help() {

	_commands() {
		PRINT "Command|Arguments|Description "
		PRINT "(l) lock||Lock your computer"
		PRINT "(u) unlock||Unlock your computer"
		PRINT "(e) exit||Logout of all sessions"
		PRINT "(p) print-sessions||View all session IDs"
		PRINT "(h) help||View this prompt"
		PRINT
	}

	PRINT
	PRINT "Lock/Unlock your computer from the command line"
	PRINT
	PRINT "Usage:	lockd [command] <args?[]>"
	PRINT "Example: lockd lock"
	PRINT
	_commands | column -t -s "|"
	
	return 0
}

# Get the cli command
arg="$(printf '%b' "$1" | tr '[:upper:]' '[:lower:]')"

case "$arg" in

	l | lock ) _lock ;;

	u | unlock ) _unlock ;;

	e | exit ) _logout ;;
	
	p | print-sessions ) _list ;;
	
	h | help ) _help ;;
	
	* ) [[ -z "${1}" ]] && _help && exit 0; PRINT "Invalid Command '${arg}'!" ;;
esac
